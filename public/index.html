<!DOCTYPE html>
<html>
<head>
  <title>ü§ñ AI Crypto Trading Scanner Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, #1f2937, #0f172a 55%, #020617 100%);
      min-height: 100vh;
      color: #1a202c;
    }
    .container {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 380px;
      gap: 24px;
      max-width: 1920px;
      margin: 0 auto;
      padding: 24px;
    }
    .main-content, .sidebar {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
    }
    .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid rgba(148, 163, 184, 0.2); }
    .header h1 {
      color: #0f172a;
      font-size: 2.75em;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #6366f1, #22d3ee);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .subtitle {
      color: #334155;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .fg-indicator {
      margin-top: 16px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.5s, color 0.5s;
    }
    .fg-label { opacity: 0.7; }
    .fg-value { font-weight: 700; }
    .fg-score { font-size: 0.9em; opacity: 0.8; }
    .fg-indicator.extreme-fear { background: rgba(239, 68, 68, 0.15); color: #b91c1c; }
    .fg-indicator.fear { background: rgba(245, 158, 11, 0.15); color: #b45309; }
    .fg-indicator.neutral { background: rgba(100, 116, 139, 0.15); color: #475569; }
    .fg-indicator.greed { background: rgba(132, 204, 22, 0.15); color: #4d7c0f; }
    .fg-indicator.extreme-greed { background: rgba(34, 197, 94, 0.15); color: #15803d; }
    .controls {
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.9));
      padding: 28px;
      border-radius: 20px;
      margin-bottom: 28px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .heatmap-section {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.05), rgba(59, 130, 246, 0.08));
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 28px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
      color: #0f172a;
    }
    .section-header small {
      color: #475569;
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .heatmap-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 24px;
      color: #475569;
      background: rgba(241, 245, 249, 0.7);
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
    }
    .heatmap-cell {
      padding: 16px;
      border-radius: 14px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      transition: transform 0.2s ease;
    }
    .heatmap-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.12);
    }
    .heatmap-coin {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: 600;
      color: #0f172a;
    }
    .heatmap-score {
      font-size: 1.4em;
      font-weight: 700;
    }
    .heatmap-frames {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
      font-size: 0.7em;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .heatmap-frame {
      padding: 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.06);
      text-align: center;
      font-weight: 600;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: white;
      white-space: nowrap;
    }
    .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #4338ca); }
    .btn-secondary { background: linear-gradient(135deg, #475569, #334155); }
    .btn-telegram { background: linear-gradient(135deg, #0088cc, #0369a1); }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
      opacity: 0.9;
    }
    button:active {
      transform: translateY(0);
    }
    .status-card {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: white;
      padding: 24px;
      border-radius: 16px;
      text-align: center;
    }
    .status-card h4 { margin-bottom: 8px; font-size: 1.2em; }
    .status-meta { font-size: 0.85em; opacity: 0.85; margin-top: 8px; }
    .opportunity {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      border-left: 6px solid;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.12);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .opportunity::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 20px;
      background: radial-gradient(circle at top right, rgba(14, 165, 233, 0.15), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .opportunity:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.18);
    }
    .opportunity:hover::before { opacity: 1; }
    .opportunity.buy { border-left-color: #22c55e; }
    .opportunity.sell { border-left-color: #ef4444; }
    .opportunity.hold { border-left-color: #f59e0b; }
    .coin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .coin-name { font-size: 1.4em; font-weight: 700; color: #0f172a; }
    .action-badge {
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .buy-badge { background: rgba(34, 197, 94, 0.15); color: #15803d; }
    .sell-badge { background: rgba(239, 68, 68, 0.15); color: #b91c1c; }
    .hold-badge { background: rgba(245, 158, 11, 0.15); color: #b45309; }
    .price-confidence {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin: 20px 0;
      padding: 20px;
      background: rgba(148, 163, 184, 0.08);
      border-radius: 12px;
    }
    .price-box .value, .confidence-box .value {
      font-size: 1.6em;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .confidence-bar {
      height: 10px;
      background: rgba(226, 232, 240, 0.7);
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
    }
    .confidence-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.8s;
    }
    .high-confidence { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .medium-confidence { background: linear-gradient(90deg, #f59e0b, #d97706); }
    .low-confidence { background: linear-gradient(90deg, #ef4444, #b91c1c); }
    .technical-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    .technical-item {
      background: rgba(241, 245, 249, 0.85);
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .timeframe-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 16px 0;
    }
    .timeframe-card {
      border-radius: 12px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .timeframe-card h5 {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
      margin-bottom: 8px;
    }
    .timeframe-card .metric {
      font-size: 0.9em;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .technical-item strong {
      display: block;
      color: #475569;
      font-size: 0.75em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .reason-box {
      margin: 16px 0;
      padding: 16px;
      background: rgba(148, 163, 184, 0.08);
      border-radius: 12px;
      border-left: 4px solid #6366f1;
    }
    .insights-list ul { list-style: none; padding: 0; }
    .insights-list li {
      padding: 10px 12px;
      margin-bottom: 8px;
      background: rgba(241, 245, 249, 0.85);
      border-radius: 8px;
      padding-left: 32px;
      position: relative;
    }
    .insights-list li::before {
      content: '‚Üí';
      position: absolute;
      left: 12px;
      color: #6366f1;
      font-weight: bold;
    }
    .no-opportunities {
      text-align: center;
      padding: 80px 20px;
      color: #64748b;
    }
    .ai-visual {
      margin-top: 20px;
      background: rgba(14, 116, 144, 0.15);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(125, 211, 252, 0.3);
    }
    .ai-visual h4 { color: #bae6fd; font-size: 1.1em; margin-bottom: 12px; }
    .ai-list { list-style: none; color: #bae6fd; font-size: 0.95em; }
    .ai-list li { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .ai-tag {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75em;
      background: rgba(125, 211, 252, 0.2);
      color: #0ea5e9;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .live-progress {
      margin-top: 16px;
      background: rgba(15, 23, 42, 0.6);
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .progress-bar {
      height: 6px;
      background: rgba(148, 163, 184, 0.3);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #6366f1);
      width: 0;
      transition: width 0.3s ease;
    }
    .ai-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75em;
      text-transform: uppercase;
      color: #94a3b8;
      letter-spacing: 0.12em;
      background: rgba(148, 163, 184, 0.12);
      padding: 4px 10px;
      border-radius: 999px;
      margin-right: 8px;
    }
    .history-card {
      margin-top: 20px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.55);
      border-radius: 12px;
      border: 1px solid rgba(100, 116, 139, 0.35);
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      color: #e2e8f0;
      font-size: 0.85em;
      padding: 10px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }
    .history-item:last-child { border-bottom: none; }
    @media (max-width: 1400px) { .container { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .main-content, .sidebar { padding: 20px; }
    }
    .insights-list li::before {
      content: '‚Üí';
      position: absolute;
      left: 12px;
      color: #6366f1;
      font-weight: bold;
    }
    .news-section {
      margin-top: 20px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.04);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .news-section h4 {
      margin-bottom: 10px;
      font-size: 1em;
      color: #0f172a;
    }
    .news-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .news-section li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    .news-section li:last-child {
      border-bottom: none;
    }
    .news-section a {
      color: #2563eb;
      text-decoration: none;
    }
    .news-section a:hover {
      text-decoration: underline;
    }
    .mock-data-warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      color: #92400e;
    }
    .mock-data-warning h4 {
      color: #92400e;
      margin-bottom: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    .sidebar {
      position: sticky;
      top: 24px;
      height: fit-content;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }
    .sidebar::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 10px;
    }
    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.5);
      border-radius: 10px;
    }
    .sidebar::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.7);
    }
    .log-container {
      scrollbar-width: thin;
      scrollbar-color: rgba(59, 130, 246, 0.5) rgba(15, 23, 42, 0.3);
    }
    .log-container::-webkit-scrollbar {
      width: 6px;
    }
    .log-container::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 10px;
    }
    .log-container::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.5);
      border-radius: 10px;
    }
    .log-container::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.7);
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(59, 130, 246, 0.1);
      word-wrap: break-word;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-timestamp {
      color: #6a9955;
      margin-right: 8px;
      font-weight: 600;
    }
    .log-message {
      color: #d4d4d4;
    }
    .log-info .log-message {
      color: #cbd5e1;
    }
    .log-success .log-message {
      color: #4ec9b0;
    }
    .log-warning .log-message {
      color: #d7ba7d;
    }
    .log-error .log-message {
      color: #f48771;
    }
    /* Active Trades Dashboard Styles - List View */
    .active-trades-container {
      background: white;
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.12);
      margin-bottom: 28px;
      overflow: hidden;
    }
    .trades-table {
      width: 100%;
      border-collapse: collapse;
    }
    .trades-table thead {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.05), rgba(59, 130, 246, 0.08));
    }
    .trades-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #475569;
      border-bottom: 2px solid rgba(148, 163, 184, 0.2);
    }
    .trades-table td {
      padding: 16px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      color: #334155;
      font-size: 0.95em;
    }
    .trades-table tbody tr {
      transition: background-color 0.2s ease;
    }
    .trades-table tbody tr:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }
    .trades-table tbody tr:last-child td {
      border-bottom: none;
    }
    .trade-action-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.85em;
      display: inline-block;
    }
    .trade-action-badge.buy {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
    }
    .trade-action-badge.sell {
      background: rgba(239, 68, 68, 0.15);
      color: #b91c1c;
    }
    .trade-coin-name {
      font-weight: 600;
      color: #0f172a;
    }
    .trade-price {
      font-family: 'Courier New', monospace;
      color: #334155;
    }
    .trade-pnl-value {
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }
    .trade-pnl-value.positive {
      color: #22c55e;
    }
    .trade-pnl-value.negative {
      color: #ef4444;
    }
    .trade-pnl-value.neutral {
      color: #f59e0b;
    }
    .trade-status-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    .trade-status-badge.open {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
    }
    .trade-status-badge.tp_hit {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
    }
    .trade-status-badge.sl_hit {
      background: rgba(239, 68, 68, 0.15);
      color: #b91c1c;
    }
    .trade-status-badge.dca_hit {
      background: rgba(245, 158, 11, 0.15);
      color: #b45309;
    }
    .trade-time-small {
      font-size: 0.8em;
      color: #94a3b8;
    }
    .no-active-trades {
      text-align: center;
      padding: 50px 20px;
      background: rgba(241, 245, 249, 0.7);
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      color: #64748b;
    }
    /* Portfolio Display Styles - Compact */
    .portfolio-container {
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      margin-bottom: 20px;
    }
    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .portfolio-metric {
      background: rgba(241, 245, 249, 0.85);
      padding: 8px 10px;
      border-radius: 8px;
      border-left: 3px solid #6366f1;
    }
    .portfolio-metric-label {
      font-size: 0.7em;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .portfolio-metric-value {
      font-size: 1em;
      font-weight: 700;
      color: #0f172a;
      font-family: 'Courier New', monospace;
    }
    .portfolio-metric-value.positive {
      color: #22c55e;
    }
    .portfolio-metric-value.negative {
      color: #ef4444;
    }
    .no-active-trades h3 {
      margin-bottom: 10px;
      color: #475569;
    }
    @media (max-width: 1200px) {
      .trades-table {
        font-size: 0.85em;
      }
      .trades-table th,
      .trades-table td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>ü§ñ AI Crypto Trading Scanner Pro</h1>
        <div class="subtitle">Multi-API Technical Analysis ‚Ä¢ AI Validation ‚Ä¢ Real-time Data</div>
        <div id="fearGreedIndicator" class="fg-indicator" style="display: none;">
          <span class="fg-label">Sentiment:</span>
          <span id="fearGreedClassification" class="fg-value">Neutral</span>
          <span id="fearGreedValue" class="fg-score">(50)</span>
        </div>
      </div>

      <div id="scanProgressContainer" style="display:none; margin-bottom: 20px;">
        <div style="display:flex; justify-content:space-between; color:#475569; font-weight:600; margin-bottom:6px;">
          <span>Current scan progress</span>
          <span id="scanProgressText">0%</span>
        </div>
        <div style="height:10px; background:rgba(226,232,240,0.7); border-radius:12px; overflow:hidden;">
          <div id="scanProgressFill" style="height:100%; width:0%; background:linear-gradient(90deg,#38bdf8,#6366f1); transition:width 0.4s;"></div>
        </div>
      </div>

      <div class="controls">
        <h3>üéØ Scanner Controls</h3>
        <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center; margin-bottom:16px;">
          <label for="intervalSelect" style="font-weight:600; color:#475569;">Auto-scan interval</label>
          <select id="intervalSelect" onchange="changeInterval(this.value)" style="padding:10px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.4); background:white; color:#0f172a;">
            <option value="10m">Every 10 minutes</option>
            <option value="1h" selected>Every 1 hour</option>
            <option value="4h">Every 4 hours</option>
            <option value="1d">Daily</option>
            <option value="1w">Weekly</option>
          </select>
        </div>
        <div class="button-group">
          <button class="btn-success" onclick="startAutoScan()">üöÄ Start Auto-Scan</button>
          <button class="btn-danger" onclick="stopAutoScan()">üõë Stop Auto-Scan</button>
          <button class="btn-primary" onclick="manualScan()">üîç Scan Now</button>
          <button class="btn-telegram" onclick="testTelegram(event)">üì± Test Telegram</button>
          <button class="btn-secondary" onclick="toggleRules()">‚öôÔ∏è Trading Rules</button>
          <button class="btn-secondary" onclick="toggleTradeMonitoring()">üéØ Trade Monitoring</button>
          <button class="btn-secondary" onclick="runDiagnostics()">üîß Diagnostics</button>
        </div>
        
        <div class="status-card">
          <h4>Scanner Status</h4>
          <div id="statusText">üü¢ Ready to start</div>
          <div id="nextScan">Next scan: Not scheduled</div>
        </div>
      </div>

      <!-- Trading Rules Panel -->
      <div id="rulesPanel" style="display:none; background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.9)); padding: 28px; border-radius: 20px; margin-bottom: 28px; border: 1px solid rgba(148,163,184,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: #0f172a; font-size: 1.5em; font-weight: 700;">‚öôÔ∏è Trading Rules & Patterns</h3>
          <div style="display: flex; gap: 10px;">
            <button id="editRulesBtn" onclick="toggleEditMode()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úèÔ∏è Edit Rules</button>
            <button onclick="toggleRules()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úï Close</button>
          </div>
        </div>
        
        <div id="rulesContent" style="color: #0f172a;">
          <div style="margin-bottom: 24px;">
            <h4 style="color: #6366f1; margin-bottom: 12px; font-size: 1.2em;">üìä Confidence Threshold</h4>
            <div id="confidenceDisplay" style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #6366f1;">
              <div style="font-size: 1.5em; font-weight: 700; color: #0f172a;" id="confidenceThreshold">65%</div>
              <div style="color: #64748b; margin-top: 4px;">Minimum confidence required to trigger an opportunity</div>
            </div>
            <div id="confidenceEdit" style="display:none; background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #6366f1;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Confidence Threshold (%):</label>
              <input type="range" id="confidenceSlider" min="10" max="95" value="65" step="5" style="width: 100%; margin-bottom: 8px;" oninput="updateConfidenceDisplay(this.value)">
              <div style="display: flex; justify-content: space-between;">
                <span id="confidenceValue" style="font-size: 1.2em; font-weight: 700; color: #6366f1;">65%</span>
                <span style="color: #64748b; font-size: 0.9em;">10% - 95%</span>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
            <div>
              <h4 style="color: #22c55e; margin-bottom: 12px; font-size: 1.1em;">üü¢ BUY Patterns</h4>
              <div id="buyPatterns" style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                  <li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">Loading...</li>
                </ul>
              </div>
              <div id="buyPatternsEdit" style="display:none; background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #22c55e; margin-top: 12px;">
                <label style="display: flex; align-items: center; margin-bottom: 12px;">
                  <input type="checkbox" id="buyEnabled" checked style="margin-right: 8px;">
                  <span>Enable BUY signals</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequireRSI" checked style="margin-right: 8px;">
                  <span>Require RSI Oversold</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequireBollinger" style="margin-right: 8px;">
                  <span>Require Bollinger Lower</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequireSupport" style="margin-right: 8px;">
                  <span>Require Support Level</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequireFibonacci" style="margin-right: 8px;">
                  <span>Require Fibonacci Support</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequireTrend" style="margin-right: 8px;">
                  <span>Require Bullish Trend</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="buyRequirePattern" style="margin-right: 8px;">
                  <span>Require Trading Pattern (Channels, H&S, etc.)</span>
                </label>
                <div style="margin-top: 12px;">
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Min Timeframe Alignment:</label>
                  <input type="number" id="buyTimeframeAlignment" min="1" max="5" value="2" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid #ccc;">
                </div>
              </div>
            </div>
            <div>
              <h4 style="color: #ef4444; margin-bottom: 12px; font-size: 1.1em;">üî¥ SELL Patterns</h4>
              <div id="sellPatterns" style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                  <li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">Loading...</li>
                </ul>
              </div>
              <div id="sellPatternsEdit" style="display:none; background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444; margin-top: 12px;">
                <label style="display: flex; align-items: center; margin-bottom: 12px;">
                  <input type="checkbox" id="sellEnabled" checked style="margin-right: 8px;">
                  <span>Enable SELL signals</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequireRSI" checked style="margin-right: 8px;">
                  <span>Require RSI Overbought</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequireBollinger" style="margin-right: 8px;">
                  <span>Require Bollinger Upper</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequireResistance" style="margin-right: 8px;">
                  <span>Require Resistance Level</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequireFibonacci" style="margin-right: 8px;">
                  <span>Require Fibonacci Resistance</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequireTrend" style="margin-right: 8px;">
                  <span>Require Bearish Trend</span>
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="checkbox" id="sellRequirePattern" style="margin-right: 8px;">
                  <span>Require Trading Pattern (Channels, H&S, etc.)</span>
                </label>
                <div style="margin-top: 12px;">
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Min Timeframe Alignment:</label>
                  <input type="number" id="sellTimeframeAlignment" min="1" max="5" value="2" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid #ccc;">
                </div>
              </div>
            </div>
            <div>
              <h4 style="color: #f59e0b; margin-bottom: 12px; font-size: 1.1em;">üü° HOLD Patterns</h4>
              <div id="holdPatterns" style="background: white; padding: 16px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                  <li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">Loading...</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div id="saveRulesSection" style="display:none; margin-top: 24px; padding: 20px; background: white; border-radius: 12px; border: 2px solid #6366f1;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="color: #6366f1; margin-bottom: 4px;">Save Your Changes</h4>
                <p style="color: #64748b; font-size: 0.9em; margin: 0;">Your custom rules will be applied to all future scans</p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="saveTradingRules()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">üíæ Save Rules</button>
                <button onclick="cancelEdit()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Trade Monitoring Panel -->
      <div id="tradeMonitoringPanel" style="display:none; background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.9)); padding: 28px; border-radius: 20px; margin-bottom: 28px; border: 1px solid rgba(148,163,184,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="color: #0f172a; font-size: 1.5em; font-weight: 700;">üéØ Trade Monitoring Settings</h3>
          <button onclick="toggleTradeMonitoring()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úï Close</button>
        </div>
        
        <div style="color: #0f172a;">
          <div style="margin-bottom: 24px;">
            <h4 style="color: #6366f1; margin-bottom: 12px; font-size: 1.2em;">üìè Proximity Threshold</h4>
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #6366f1;">
              <p style="color: #64748b; margin-bottom: 16px;">Trigger Premium AI evaluation when trade is within this percentage of DCA, Stop Loss, or Take Profit levels.</p>
              
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                <label style="font-weight: 600; min-width: 120px;">Threshold:</label>
                <input type="range" id="proximitySlider" min="0.5" max="10" value="1.0" step="0.5" style="flex: 1;" oninput="updateProximityDisplay(this.value)">
                <span id="proximityValue" style="font-size: 1.3em; font-weight: 700; color: #6366f1; min-width: 60px;">1.0%</span>
              </div>
              
              <button onclick="saveProximityThreshold()" style="background: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">üíæ Save Settings</button>
            </div>
          </div>

          <div style="margin-bottom: 24px;">
            <h4 style="color: #8b5cf6; margin-bottom: 12px; font-size: 1.2em;">‚ÑπÔ∏è How It Works</h4>
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #8b5cf6;">
              <ul style="margin: 0; padding-left: 20px; color: #64748b; line-height: 1.8;">
                <li><strong>DCA Proximity:</strong> AI evaluates if you should add to position</li>
                <li><strong>Stop Loss Proximity:</strong> AI checks if SL should be adjusted</li>
                <li><strong>Take Profit Proximity:</strong> AI decides to hold or close</li>
                <li><strong>Cooldown:</strong> 5 minutes between AI evaluations per trade</li>
                <li><strong>Notifications:</strong> Get Telegram alerts with AI recommendations</li>
              </ul>
            </div>
          </div>

          <div>
            <h4 style="color: #f59e0b; margin-bottom: 12px; font-size: 1.2em;">üìä Current Status</h4>
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                  <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Service Status</div>
                  <div id="monitoringStatus" style="font-size: 1.2em; font-weight: 700;">üü¢ Active</div>
                </div>
                <div>
                  <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Check Interval</div>
                  <div style="font-size: 1.2em; font-weight: 700;">30 seconds</div>
                </div>
                <div>
                  <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Active Trades</div>
                  <div id="monitoredTrades" style="font-size: 1.2em; font-weight: 700;">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom: 24px; color: #0f172a; font-size: 1.5em; font-weight: 700;">üíº Portfolio</h3>
        <div id="portfolio-container" class="portfolio-container">
          <div class="portfolio-grid">
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Initial Capital</div>
              <div class="portfolio-metric-value" id="portfolio-initial">$10,000.00</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Current Balance</div>
              <div class="portfolio-metric-value" id="portfolio-balance">$10,000.00</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Total Equity</div>
              <div class="portfolio-metric-value" id="portfolio-equity">$10,000.00</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Total P&L</div>
              <div class="portfolio-metric-value" id="portfolio-pnl">$0.00</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">ROI</div>
              <div class="portfolio-metric-value" id="portfolio-roi">0.00%</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Win Rate</div>
              <div class="portfolio-metric-value" id="portfolio-winrate">0.00%</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Total Trades</div>
              <div class="portfolio-metric-value" id="portfolio-trades">0</div>
            </div>
            <div class="portfolio-metric">
              <div class="portfolio-metric-label">Open Positions</div>
              <div class="portfolio-metric-value" id="portfolio-open">0</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom: 24px; color: #0f172a; font-size: 1.5em; font-weight: 700;">üìä Performance Analytics</h3>
        <div id="analytics-container" style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div id="analytics-loading" style="text-align: center; padding: 40px; color: #64748b;">
            <p>Loading analytics...</p>
          </div>
          <div id="analytics-content" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
              <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 16px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Sharpe Ratio</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0f172a;" id="analytics-sharpe">-</div>
              </div>
              <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444;">
                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Max Drawdown</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0f172a;" id="analytics-drawdown">-</div>
              </div>
              <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 16px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Avg Holding Time</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0f172a;" id="analytics-holding">-</div>
              </div>
              <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); padding: 16px; border-radius: 12px; border-left: 4px solid #a855f7;">
                <div style="font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Best Trade</div>
                <div style="font-size: 1.2em; font-weight: 700; color: #0f172a;" id="analytics-best">-</div>
              </div>
            </div>
            <div style="margin-top: 24px;">
              <h4 style="color: #0f172a; margin-bottom: 12px;">Win Rate by Coin</h4>
              <div id="analytics-winrate-by-coin" style="background: #f8fafc; padding: 16px; border-radius: 12px; min-height: 100px;">
                <p style="color: #64748b; text-align: center;">No trade data available</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="margin: 0; color: #0f172a; font-size: 1.5em; font-weight: 700;">üí∞ Active Trades</h3>
          <button id="evaluateTradesBtn" onclick="evaluateTradesWithAI()" style="padding: 10px 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">ü§ñ AI Re-evaluate Trades</button>
        </div>
        <div id="active-trades-container" class="active-trades-container">
          <div class="no-active-trades">
            <h3>No Active Trades</h3>
            <p>Active trades will appear here when BUY or SELL signals are triggered.</p>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom: 24px; color: #0f172a; font-size: 1.5em; font-weight: 700;">üìä Closed Trades</h3>
        <div id="closed-trades-container" class="active-trades-container">
          <div class="no-active-trades">
            <h3>No Closed Trades</h3>
            <p>Closed trades will appear here for performance tracking.</p>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin-bottom: 24px; color: #0f172a; font-size: 1.5em; font-weight: 700;">üìà Trading Opportunities</h3>
        <div id="results">
          <div class="no-opportunities">
            <h3>üîç Ready to Scan</h3>
            <p>Click "Scan Now" to start comprehensive technical analysis</p>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.95)); color: white; border-radius: 24px; padding: 26px; box-shadow: 0 20px 40px rgba(15,23,42,0.5); border: 1px solid rgba(59,130,246,0.2); height: calc(100vh - 48px); display: flex; flex-direction: column;">
        <!-- Free Tier Monitoring Section -->
        <div class="panel-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(59,130,246,0.2);">
          <h3 style="margin: 0; font-size: 1em; letter-spacing: 0.05em; text-transform: uppercase; color: #22d3ee; font-weight: 700;">üîç Free AI Monitoring</h3>
          <span id="monitoring-status" style="font-size: 0.75em; padding: 4px 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-weight: 600;">ACTIVE</span>
        </div>
        
        <div id="monitoring-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 16px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2); font-size: 11px;">
          <div style="text-align: center; padding: 20px; color: #94a3b8;">
            <div style="font-size: 2em; margin-bottom: 8px;">‚è≥</div>
            <div>Waiting for monitoring cycle...</div>
          </div>
        </div>
        
        <!-- Active Triggers Section -->
        <div class="panel-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-top: 1px solid rgba(59,130,246,0.2); margin-top: 16px; padding-top: 16px;">
          <h3 style="margin: 0; font-size: 1em; letter-spacing: 0.05em; text-transform: uppercase; color: #22d3ee; font-weight: 700;">üéØ Active Triggers</h3>
          <button onclick="openTriggerSettings()" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; background: rgba(99, 102, 241, 0.2); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); font-weight: 600;">‚öôÔ∏è Settings</button>
        </div>
        
        <div id="trigger-summary" style="margin-bottom: 8px; font-size: 11px; color: #94a3b8;">
          <span style="background: rgba(148, 163, 184, 0.2); padding: 4px 8px; border-radius: 4px;">0 Active</span>
        </div>
        
        <div id="trigger-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 16px; padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2); font-size: 11px;">
          <div style="text-align: center; padding: 20px; color: #94a3b8;">
            <div style="font-size: 1.5em; margin-bottom: 8px;">üéØ</div>
            <div>No active triggers</div>
          </div>
        </div>
        
        <div class="panel-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-top: 1px solid rgba(59,130,246,0.2); padding-top: 16px;">
          <h3 style="margin: 0; font-size: 1em; letter-spacing: 0.05em; text-transform: uppercase; color: #22d3ee; font-weight: 700;">üìã Bot Activity Log</h3>
          <button id="clear-logs" class="btn btn-sm btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px; cursor: pointer;">Clear</button>
        </div>
        
        <div id="log-container" class="log-container" style="flex: 1; overflow-y: auto; font-family: 'Fira Code', 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.6; padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border: 1px solid rgba(59,130,246,0.2);"></div>
      </div>
    </div>
  </div>

  <script>
    // JavaScript code from the original file would go here
    // For brevity, including the main structure
    let analysisUpdateInterval = null;
    let scanInFlight = false;
    let progressPollInterval = null;
    let progressBarHideTimeout = null;
    let lastProgressState = { running: false, percent: 0 };
    
    async function updateProgress() {
      try {
        const response = await fetch(API_BASE + '/scan-progress');
        const progress = await response.json();
        
        if (!progress) {
          return;
        }
        
        const percent = progress.percent || 0;
        const isRunning = progress.running || false;
        
        // Always update the progress values
        document.getElementById('scanProgressText').textContent = percent + '%';
        document.getElementById('scanProgressFill').style.width = percent + '%';
        
        // Show progress bar if scan is running
        if (isRunning) {
          // Clear any pending hide timeout
          if (progressBarHideTimeout) {
            clearTimeout(progressBarHideTimeout);
            progressBarHideTimeout = null;
          }
          document.getElementById('scanProgressContainer').style.display = 'block';
          lastProgressState = { running: true, percent: percent };
        } 
        // If scan just completed (was running, now not running, and at 100%)
        else if (lastProgressState.running && !isRunning && percent >= 100) {
          // Show 100% for a moment before hiding
          document.getElementById('scanProgressContainer').style.display = 'block';
          document.getElementById('scanProgressText').textContent = '100%';
          document.getElementById('scanProgressFill').style.width = '100%';
          
          // Hide after 1 second delay to show completion
          if (progressBarHideTimeout) {
            clearTimeout(progressBarHideTimeout);
          }
          progressBarHideTimeout = setTimeout(() => {
            document.getElementById('scanProgressContainer').style.display = 'none';
            progressBarHideTimeout = null;
          }, 1000);
          
          lastProgressState = { running: false, percent: 100 };
        }
        // If scan is not running and wasn't running before, keep hidden
        else if (!isRunning && !lastProgressState.running) {
          // Only hide if we're sure it's not running
          if (progressBarHideTimeout) {
            clearTimeout(progressBarHideTimeout);
            progressBarHideTimeout = null;
          }
          document.getElementById('scanProgressContainer').style.display = 'none';
          lastProgressState = { running: false, percent: 0 };
        }
      } catch (error) {
        console.log('Error updating progress:', error);
      }
    }
    
    // API endpoints
    const API_BASE = '/api';
    
    async function testTelegram() {
      try {
        const button = event.target;
        button.disabled = true;
        button.textContent = '‚è≥ Testing...';
        
        const response = await fetch(API_BASE + '/test-telegram', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ ' + result.message);
        } else {
          alert('‚ùå ' + (result.message || 'Failed to send test notification'));
          if (result.configStatus) {
            console.log('Config status:', result.configStatus);
          }
        }
        
        button.disabled = false;
        button.textContent = 'üì± Test Telegram';
      } catch (error) {
        alert('‚ùå Error testing Telegram: ' + error.message);
        event.target.disabled = false;
        event.target.textContent = 'üì± Test Telegram';
      }
    }

    async function runDiagnostics() {
      try {
        const response = await fetch(API_BASE + '/diagnostics');
        const data = await response.json();
        
        // Format the diagnostics output
        let message = 'üîç SYSTEM DIAGNOSTICS\n\n';
        
        // Environment variables
        message += 'üìã Environment Variables:\n';
        message += `   API_KEY: ${data.environment.API_KEY ? '‚úÖ' : '‚ùå'}\n`;
        message += `   AI_API_KEY: ${data.environment.AI_API_KEY ? '‚úÖ' : '‚ùå'}\n`;
        message += `   OPENROUTER_API_KEY: ${data.environment.OPENROUTER_API_KEY ? '‚úÖ' : '‚ùå'}\n`;
        message += `   TELEGRAM_BOT_TOKEN: ${data.environment.TELEGRAM_BOT_TOKEN ? '‚úÖ' : '‚ùå'}\n`;
        message += `   TELEGRAM_CHAT_ID: ${data.environment.TELEGRAM_CHAT_ID ? '‚úÖ' : '‚ùå'}\n`;
        message += `   ALLOW_MOCK_NOTIFICATIONS: ${data.environment.ALLOW_MOCK_NOTIFICATIONS}\n\n`;
        
        // Config status
        message += '‚öôÔ∏è Configuration:\n';
        message += `   AI API Key: ${data.config.AI_API_KEY_PRESENT ? '‚úÖ Present (' + data.config.AI_API_KEY_LENGTH + ' chars)' : '‚ùå Missing'}\n`;
        message += `   AI Model: ${data.config.AI_MODEL}\n`;
        message += `   Telegram: ${data.config.TELEGRAM_ENABLED ? '‚úÖ Enabled' : '‚ùå Disabled'}\n\n`;
        
        // Test results
        message += 'üß™ API Tests:\n';
        message += `   AI API: ${data.tests.ai.status === 'success' ? '‚úÖ ' + data.tests.ai.message : data.tests.ai.status === 'skipped' ? '‚è≠Ô∏è ' + data.tests.ai.message : '‚ùå ' + data.tests.ai.error}\n`;
        message += `   Telegram: ${data.tests.telegram.status === 'success' ? '‚úÖ ' + data.tests.telegram.message + ' (@' + data.tests.telegram.botUsername + ')' : data.tests.telegram.status === 'skipped' ? '‚è≠Ô∏è ' + data.tests.telegram.message : '‚ùå ' + data.tests.telegram.error}\n\n`;
        
        // Recommendations
        if (data.tests.ai.status !== 'success' || data.tests.telegram.status !== 'success') {
          message += 'üí° RECOMMENDATIONS:\n';
          if (data.tests.ai.status !== 'success') {
            message += '   ‚Ä¢ Set AI_API_KEY or OPENROUTER_API_KEY in environment\n';
            message += '   ‚Ä¢ Get your key from: https://openrouter.ai/keys\n';
          }
          if (data.tests.telegram.status !== 'success') {
            message += '   ‚Ä¢ Set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID\n';
            message += '   ‚Ä¢ Create bot: Talk to @BotFather on Telegram\n';
            message += '   ‚Ä¢ Get chat ID: Talk to @userinfobot on Telegram\n';
          }
        }
        
        // Show in alert (for quick view) and console (for details)
        alert(message);
        console.log('Full diagnostics:', data);
        
      } catch (error) {
        alert('‚ùå Error running diagnostics: ' + error.message);
        console.error('Diagnostics error:', error);
      }
    }

    async function startAutoScan() {
      try {
        const response = await fetch(API_BASE + '/start-scan', { method: 'POST' });
        const result = await response.json();
        if (result.status === 'already_running') {
          alert('Auto-scan is already running!');
          return;
        }
        document.getElementById('statusText').innerHTML = 'üîÑ Auto-Scanning Active';
        updateNextScanTime();
        manualScan();
      } catch (error) {
        alert('Error starting auto-scan: ' + error.message);
      }
    }
    
    // Function to update next scan time display
    async function updateNextScanTime() {
      try {
        const response = await fetch(API_BASE + '/bot-status');
        const status = await response.json();
        
        if (status.running && status.nextScan) {
          const nextScanDate = new Date(status.nextScan);
          const now = new Date();
          const timeUntil = nextScanDate - now;
          
          if (timeUntil > 0) {
            // Format time until next scan
            const hours = Math.floor(timeUntil / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeUntil % (1000 * 60)) / 1000);
            
            let timeStr = '';
            if (hours > 0) {
              timeStr = `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
              timeStr = `${minutes}m ${seconds}s`;
            } else {
              timeStr = `${seconds}s`;
            }
            
            // Also show the actual time
            const timeStr2 = nextScanDate.toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit',
              hour12: true 
            });
            
            document.getElementById('nextScan').textContent = `Next scan: ${timeStr} (${timeStr2})`;
          } else {
            // Next scan is in the past or happening now
            document.getElementById('nextScan').textContent = 'Next scan: Running now...';
          }
        } else {
          document.getElementById('nextScan').textContent = 'Next scan: Not scheduled';
        }
      } catch (error) {
        console.error('Error updating next scan time:', error);
        document.getElementById('nextScan').textContent = 'Next scan: Unknown';
      }
    }

    async function stopAutoScan() {
      try {
        await fetch(API_BASE + '/stop-scan', { method: 'POST' });
        document.getElementById('statusText').innerHTML = 'üõë Stopped';
        document.getElementById('nextScan').textContent = 'Next scan: Manual mode';
      } catch (error) {
        alert('Error stopping auto-scan: ' + error.message);
      }
    }

    async function manualScan() {
      try {
        document.getElementById('results').innerHTML = '<div class="no-opportunities"><div class="loading-spinner" style="width: 40px; height: 40px; border: 4px solid rgba(100, 116, 139, 0.2); border-top-color: #6366f1; border-radius: 999px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><h3>üîç Scanning...</h3></div>';
        
        // Reset progress state for new scan
        lastProgressState = { running: false, percent: 0 };
        if (progressBarHideTimeout) {
          clearTimeout(progressBarHideTimeout);
          progressBarHideTimeout = null;
        }
        
        // Show progress bar
        document.getElementById('scanProgressContainer').style.display = 'block';
        document.getElementById('scanProgressText').textContent = '0%';
        document.getElementById('scanProgressFill').style.width = '0%';
        
        // Start polling progress
        if (progressPollInterval) clearInterval(progressPollInterval);
        // Kick an immediate update so we don't get stuck at 60% between polls
        await updateProgress();
        progressPollInterval = setInterval(updateProgress, 800);
        
        const response = await fetch(API_BASE + '/scan-now', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`Scan request failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data) {
          throw new Error('Invalid response from server');
        }
        
        // Stop polling
        if (progressPollInterval) {
          clearInterval(progressPollInterval);
          progressPollInterval = null;
        }
        
        // Update progress state to reflect completion
        lastProgressState = { running: false, percent: 100 };
        
        // Make sure the bar shows completion before hiding
        document.getElementById('scanProgressText').textContent = '100%';
        document.getElementById('scanProgressFill').style.width = '100%';
        
        // Hide progress bar after 1 second to show completion
        if (progressBarHideTimeout) {
          clearTimeout(progressBarHideTimeout);
        }
        progressBarHideTimeout = setTimeout(() => {
          document.getElementById('scanProgressContainer').style.display = 'none';
          progressBarHideTimeout = null;
        }, 1000);
        
        if (!data.opportunities || data.opportunities.length === 0) {
          document.getElementById('results').innerHTML = '<div class="no-opportunities"><h3>üì≠ No High-Confidence Opportunities</h3><p>Scanned ' + (data.analyzedCoins || 0) + ' coins</p></div>';
          return;
        }

        // Render opportunities with patterns
        let html = '';
        data.opportunities.forEach((opp) => {
          let patternsHTML = '';
          if (opp.patterns && opp.patterns.length > 0) {
            patternsHTML = '<div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">' +
              '<div style="font-weight: 600; margin-bottom: 8px; color: #6366f1;">üìä Detected Patterns:</div>' +
              opp.patterns.map(p => {
                const signalColor = p.signal === 'BULLISH' ? '#22c55e' : p.signal === 'BEARISH' ? '#ef4444' : '#f59e0b';
                return `<div style="padding: 6px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">
                  <span style="font-weight: 600;">${p.pattern.replace(/_/g, ' ')}</span> 
                  <span style="color: ${signalColor}; font-size: 0.9em;">(${p.type})</span>
                  <span style="float: right; color: #64748b; font-size: 0.85em;">${(p.confidence * 100).toFixed(0)}%</span>
                </div>`;
              }).join('') +
              '</div>';
          }
          
          html += '<div class="opportunity ' + opp.action.toLowerCase() + '">' +
            '<div class="coin-header">' +
              '<div class="coin-name">' + opp.name + ' (' + opp.symbol + ')</div>' +
              '<div class="' + opp.action.toLowerCase() + '-badge action-badge">' + opp.action + '</div>' +
            '</div>' +
            '<div class="price-confidence">' +
              '<div class="price-box"><div class="value">' + opp.price + '</div><div>Current Price</div></div>' +
              '<div class="confidence-box"><div class="value">' + (opp.confidence * 100).toFixed(0) + '%</div><div>Confidence</div></div>' +
            '</div>' +
            patternsHTML +
            (opp.backtest && opp.backtest.winRate !== undefined ? 
              '<div style="margin-top: 12px; padding: 12px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border-left: 3px solid #6366f1;">' +
                '<div style="font-weight: 600; margin-bottom: 8px; color: #6366f1;">üìà Backtest Results:</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">' +
                  '<div><strong>Win Rate:</strong> <span style="color: ' + (opp.backtest.winRate >= 50 ? '#22c55e' : '#ef4444') + ';">' + opp.backtest.winRate.toFixed(1) + '%</span></div>' +
                  '<div><strong>Trades:</strong> ' + (opp.backtest.totalTrades || 0) + '</div>' +
                  '<div><strong>Avg Return:</strong> <span style="color: ' + (opp.backtest.avgReturn >= 0 ? '#22c55e' : '#ef4444') + ';">' + (opp.backtest.avgReturn >= 0 ? '+' : '') + opp.backtest.avgReturn.toFixed(2) + '%</span></div>' +
                  '<div><strong>Profit Factor:</strong> <span style="color: ' + (opp.backtest.profitFactor >= 1.5 ? '#22c55e' : opp.backtest.profitFactor >= 1.0 ? '#f59e0b' : '#ef4444') + '; font-weight: 700;">' + opp.backtest.profitFactor.toFixed(2) + '</span> ' + (opp.backtest.profitFactor >= 1.5 ? '‚úÖ' : opp.backtest.profitFactor >= 1.0 ? '‚ö†Ô∏è' : '‚ùå') + '</div>' +
                  '<div><strong>Max Drawdown:</strong> <span style="color: #ef4444;">' + opp.backtest.maxDrawdown.toFixed(2) + '%</span></div>' +
                  '<div><strong>Data Points:</strong> ' + (opp.backtest.dataPoints || 0) + '</div>' +
                '</div>' +
                '<div style="margin-top: 8px; padding: 6px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; font-size: 0.85em; color: #15803d;">' +
                  '‚úÖ Strategy validated on historical data' +
                '</div>' +
              '</div>' : 
              opp.backtest && opp.backtest.error ? 
              '<div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">' +
                '<div style="font-weight: 600; color: #f59e0b;">üìà Backtest:</div>' +
                '<div style="font-size: 0.9em; color: #b45309;">‚ö†Ô∏è ' + opp.backtest.error + '</div>' +
              '</div>' : '') +
            (opp.insights && opp.insights.length > 0 ? '<div class="reason-box" style="margin-top: 12px;"><strong>Insights:</strong><ul class="insights-list"><li>' + 
              opp.insights.join('</li><li>') + '</li></ul></div>' : '') +
            '</div>';
        });

        document.getElementById('results').innerHTML = html;
      } catch (error) {
        console.error('Scan error:', error);
        // Stop polling on error
        if (progressPollInterval) {
          clearInterval(progressPollInterval);
          progressPollInterval = null;
        }
        // Hide progress bar
        document.getElementById('scanProgressContainer').style.display = 'none';
        document.getElementById('results').innerHTML = '<div class="no-opportunities" style="color: #ef4444;"><h3>‚ùå Scan Failed</h3><p>' + (error.message || 'Please try again') + '</p></div>';
      }
    }

    async function updateStats() {
      try {
        const response = await fetch(API_BASE + '/bot-status');
        const data = await response.json();
        if (data.stats && data.stats.greedFearIndex) {
          const fgIndex = data.stats.greedFearIndex;
          const indicatorEl = document.getElementById('fearGreedIndicator');
          const classificationEl = document.getElementById('fearGreedClassification');
          const valueEl = document.getElementById('fearGreedValue');
          
          if (fgIndex.value !== null) {
            indicatorEl.style.display = 'inline-flex';
            classificationEl.textContent = fgIndex.classification;
            valueEl.textContent = `(${fgIndex.value})`;
            
            // Remove old classes
            indicatorEl.classList.remove('extreme-fear', 'fear', 'neutral', 'greed', 'extreme-greed');
            
            // Add new class based on classification
            const classificationClass = fgIndex.classification.toLowerCase().replace(/ /g, '-');
            indicatorEl.classList.add(classificationClass);
          } else {
            indicatorEl.style.display = 'none';
          }
        }
      } catch (error) {
        console.log('Error updating stats:', error);
      }
    }

    // Update AI evaluation display
    async function updateAIEvaluation() {
      try {
        const response = await fetch(API_BASE + '/live-analysis');
        const data = await response.json();
        
        const aiContent = document.getElementById('aiContent');
        const aiStatus = document.getElementById('aiStatus');
        
        // Check if elements exist before using them
        if (!aiContent || !aiStatus) {
          console.warn('‚ö†Ô∏è AI evaluation elements not found in DOM');
          return;
        }
        
        if (data.currentlyAnalyzing) {
          const current = data.currentlyAnalyzing;
          aiStatus.textContent = 'Analyzing';
          aiStatus.style.background = 'rgba(251, 191, 36, 0.2)';
          aiStatus.style.color = '#fbbf24';
          
          aiContent.innerHTML = `
            <div style="margin-bottom: 16px;">
              <div style="font-size: 1.1em; font-weight: 600; color: #fbbf24; margin-bottom: 8px;">${current.stage}</div>
              <div style="font-size: 0.9em; color: #94a3b8;">${current.symbol} - ${current.name}</div>
            </div>
            <div style="background: rgba(251, 191, 36, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #fbbf24;">
              <div style="font-size: 0.85em; color: #cbd5e1;">Progress: ${current.progress || 0}%</div>
            </div>
          `;
        } else if (data.batchAI && data.batchAI.results && Object.keys(data.batchAI.results).length > 0) {
          const batchAI = data.batchAI;
          if (aiStatus) {
            aiStatus.textContent = 'Complete';
            aiStatus.style.background = 'rgba(34, 197, 94, 0.2)';
            aiStatus.style.color = '#22c55e';
          }
          
          const results = batchAI.results;
          const buyCount = Object.values(results).filter(r => r.action === 'BUY').length;
          const sellCount = Object.values(results).filter(r => r.action === 'SELL').length;
          const holdCount = Object.values(results).filter(r => r.action === 'HOLD').length;
          const avgConfidence = Object.values(results).reduce((sum, r) => sum + (r.confidence || 0), 0) / Object.keys(results).length;
          
          // Show top 5 AI evaluations
          const topEvaluations = Object.entries(results)
            .sort((a, b) => (b[1].confidence || 0) - (a[1].confidence || 0))
            .slice(0, 5);
          
          let evaluationsHTML = topEvaluations.map(([symbol, result]) => {
            const actionColor = result.action === 'BUY' ? '#22c55e' : result.action === 'SELL' ? '#ef4444' : '#f59e0b';
            return `
              <div style="margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border-left: 3px solid ${actionColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <span style="font-weight: 600; color: #e2e8f0;">${symbol}</span>
                  <span style="font-size: 0.85em; color: ${actionColor}; font-weight: 600;">${result.action}</span>
                </div>
                <div style="font-size: 0.8em; color: #94a3b8; margin-bottom: 4px;">${result.reason || 'AI evaluation'}</div>
                <div style="font-size: 0.75em; color: #64748b;">Confidence: ${((result.confidence || 0) * 100).toFixed(0)}%</div>
              </div>
            `;
          }).join('');
          
          aiContent.innerHTML = `
            <div style="margin-bottom: 16px;">
              <div style="font-size: 1em; font-weight: 600; color: #22d3ee; margin-bottom: 12px;">Batch Analysis Complete</div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                <div style="text-align: center; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 6px;">
                  <div style="font-size: 1.2em; font-weight: 700; color: #22c55e;">${buyCount}</div>
                  <div style="font-size: 0.7em; color: #94a3b8;">BUY</div>
                </div>
                <div style="text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                  <div style="font-size: 1.2em; font-weight: 700; color: #ef4444;">${sellCount}</div>
                  <div style="font-size: 0.7em; color: #94a3b8;">SELL</div>
                </div>
                <div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                  <div style="font-size: 1.2em; font-weight: 700; color: #f59e0b;">${holdCount}</div>
                  <div style="font-size: 0.7em; color: #94a3b8;">HOLD</div>
                </div>
              </div>
              <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 12px;">
                Avg Confidence: ${(avgConfidence * 100).toFixed(0)}% | Coins: ${batchAI.coinsAnalyzed || 0}
              </div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
              <div style="font-size: 0.85em; color: #38bdf8; margin-bottom: 8px; font-weight: 600;">Top Evaluations:</div>
              ${evaluationsHTML}
            </div>
          `;
          
          // Stats elements removed
        } else {
          if (aiStatus) {
            aiStatus.textContent = 'Ready';
            aiStatus.style.background = 'rgba(148, 163, 184, 0.2)';
            aiStatus.style.color = '#94a3b8';
          }
          if (aiContent) {
            aiContent.innerHTML = `
            <div style="font-size: 2em; margin-bottom: 10px;">ü§ñ</div>
            <div>Waiting for batch AI analysis...</div>
            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 10px;">All coins analyzed together in one API call</div>
          `;
          }
        }
      } catch (error) {
        console.error('‚ùå Error updating AI evaluation:', error);
        console.error('Error stack:', error.stack);
      }
    }

    async function changeInterval(interval) {
      try {
        const response = await fetch(API_BASE + '/auto-scan-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ interval })
        });
        const result = await response.json();
        if (result.success) {
          console.log('Interval changed to:', interval);
        }
      } catch (error) {
        console.error('Error changing interval:', error);
      }
    }

    function viewHistory() {
      alert('History feature coming soon!');
    }

    // Trading Rules functions
    function toggleRules() {
      const panel = document.getElementById('rulesPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadTradingRules();
      } else {
        panel.style.display = 'none';
      }
    }

    let currentRules = null;
    let editMode = false;

    async function loadTradingRules() {
      try {
        const response = await fetch(API_BASE + '/trading-rules');
        const rules = await response.json();
        currentRules = rules;
        
        // Update confidence threshold
        const confidencePercent = parseInt(rules.confidenceThreshold);
        document.getElementById('confidenceThreshold').textContent = rules.confidenceThreshold;
        document.getElementById('confidenceSlider').value = confidencePercent;
        document.getElementById('confidenceValue').textContent = rules.confidenceThreshold;
        
        // Update patterns
        const buyPatterns = rules.patterns.buy.description || rules.patterns.buy;
        const sellPatterns = rules.patterns.sell.description || rules.patterns.sell;
        const buyList = Array.isArray(buyPatterns) ? buyPatterns : [buyPatterns];
        const sellList = Array.isArray(sellPatterns) ? sellPatterns : [sellPatterns];
        
        document.getElementById('buyPatterns').innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' +
          buyList.map(p => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">‚úì ${p}</li>`).join('') + '</ul>';
        
        document.getElementById('sellPatterns').innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' +
          sellList.map(p => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">‚úì ${p}</li>`).join('') + '</ul>';
        
        document.getElementById('holdPatterns').innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' +
          rules.patterns.hold.map(p => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.2);">‚úì ${p}</li>`).join('') + '</ul>';
        
        // Update edit form values
        if (rules.patterns && rules.patterns.buy) {
          document.getElementById('buyEnabled').checked = rules.patterns.buy.enabled !== false;
          document.getElementById('buyRequireRSI').checked = rules.patterns.buy.requireRSIOversold || false;
          document.getElementById('buyRequireBollinger').checked = rules.patterns.buy.requireBollingerLower || false;
          document.getElementById('buyRequireSupport').checked = rules.patterns.buy.requireSupportLevel || false;
          document.getElementById('buyRequireFibonacci').checked = rules.patterns.buy.requireFibonacciSupport || false;
          document.getElementById('buyRequireTrend').checked = rules.patterns.buy.requireBullishTrend || false;
          document.getElementById('buyRequirePattern').checked = rules.patterns.buy.requirePattern || false;
          document.getElementById('buyTimeframeAlignment').value = rules.patterns.buy.minTimeframeAlignment || 2;
        }
        
        if (rules.patterns && rules.patterns.sell) {
          document.getElementById('sellEnabled').checked = rules.patterns.sell.enabled !== false;
          document.getElementById('sellRequireRSI').checked = rules.patterns.sell.requireRSIOverbought || false;
          document.getElementById('sellRequireBollinger').checked = rules.patterns.sell.requireBollingerUpper || false;
          document.getElementById('sellRequireResistance').checked = rules.patterns.sell.requireResistanceLevel || false;
          document.getElementById('sellRequireFibonacci').checked = rules.patterns.sell.requireFibonacciResistance || false;
          document.getElementById('sellRequireTrend').checked = rules.patterns.sell.requireBearishTrend || false;
          document.getElementById('sellRequirePattern').checked = rules.patterns.sell.requirePattern || false;
          document.getElementById('sellTimeframeAlignment').value = rules.patterns.sell.minTimeframeAlignment || 2;
        }
        
      } catch (error) {
        console.error('Error loading trading rules:', error);
      }
    }

    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById('editRulesBtn');
      
      if (editMode) {
        btn.textContent = 'üëÅÔ∏è View Mode';
        btn.style.background = '#64748b';
        document.getElementById('confidenceDisplay').style.display = 'none';
        document.getElementById('confidenceEdit').style.display = 'block';
        document.getElementById('buyPatterns').style.display = 'none';
        document.getElementById('buyPatternsEdit').style.display = 'block';
        document.getElementById('sellPatterns').style.display = 'none';
        document.getElementById('sellPatternsEdit').style.display = 'block';
        document.getElementById('saveRulesSection').style.display = 'block';
      } else {
        btn.textContent = '‚úèÔ∏è Edit Rules';
        btn.style.background = '#6366f1';
        document.getElementById('confidenceDisplay').style.display = 'block';
        document.getElementById('confidenceEdit').style.display = 'none';
        document.getElementById('buyPatterns').style.display = 'block';
        document.getElementById('buyPatternsEdit').style.display = 'none';
        document.getElementById('sellPatterns').style.display = 'block';
        document.getElementById('sellPatternsEdit').style.display = 'none';
        document.getElementById('saveRulesSection').style.display = 'none';
        loadTradingRules(); // Reload to show current values
      }
    }

    function updateConfidenceDisplay(value) {
      document.getElementById('confidenceValue').textContent = value + '%';
    }

    async function saveTradingRules() {
      try {
        const confidence = parseInt(document.getElementById('confidenceSlider').value) / 100;
        
        const newRules = {
          minConfidence: confidence,
          patterns: {
            buy: {
              enabled: document.getElementById('buyEnabled').checked,
              requireRSIOversold: document.getElementById('buyRequireRSI').checked,
              requireBollingerLower: document.getElementById('buyRequireBollinger').checked,
              requireSupportLevel: document.getElementById('buyRequireSupport').checked,
              requireFibonacciSupport: document.getElementById('buyRequireFibonacci').checked,
              requireBullishTrend: document.getElementById('buyRequireTrend').checked,
              requirePattern: document.getElementById('buyRequirePattern').checked,
              minTimeframeAlignment: parseInt(document.getElementById('buyTimeframeAlignment').value)
            },
            sell: {
              enabled: document.getElementById('sellEnabled').checked,
              requireRSIOverbought: document.getElementById('sellRequireRSI').checked,
              requireBollingerUpper: document.getElementById('sellRequireBollinger').checked,
              requireResistanceLevel: document.getElementById('sellRequireResistance').checked,
              requireFibonacciResistance: document.getElementById('sellRequireFibonacci').checked,
              requireBearishTrend: document.getElementById('sellRequireTrend').checked,
              requirePattern: document.getElementById('sellRequirePattern').checked,
              minTimeframeAlignment: parseInt(document.getElementById('sellTimeframeAlignment').value)
            }
          }
        };

        const response = await fetch(API_BASE + '/trading-rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newRules)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Trading rules saved successfully!');
          toggleEditMode(); // Switch back to view mode
          loadTradingRules(); // Reload to show updated rules
        } else {
          alert('‚ùå Error saving rules: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        alert('‚ùå Error saving rules: ' + error.message);
        console.error('Error saving trading rules:', error);
      }
    }

    function cancelEdit() {
      toggleEditMode();
    }

    // Trade Monitoring functions
    function toggleTradeMonitoring() {
      const panel = document.getElementById('tradeMonitoringPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadTradeMonitoringSettings();
      } else {
        panel.style.display = 'none';
      }
    }

    async function loadTradeMonitoringSettings() {
      try {
        const response = await fetch(API_BASE + '/trade-monitoring/settings');
        const settings = await response.json();
        
        // Update proximity threshold slider
        document.getElementById('proximitySlider').value = settings.proximityThreshold;
        document.getElementById('proximityValue').textContent = settings.proximityThreshold + '%';
        
        // Update status indicators
        document.getElementById('monitoringStatus').textContent = settings.isRunning ? 'üü¢ Active' : 'üî¥ Stopped';
        
        // Update monitored trades count (fetch from active trades)
        const tradesResponse = await fetch(API_BASE + '/active-trades');
        const trades = await tradesResponse.json();
        document.getElementById('monitoredTrades').textContent = trades.length || 0;
      } catch (error) {
        console.error('Error loading trade monitoring settings:', error);
      }
    }

    function updateProximityDisplay(value) {
      document.getElementById('proximityValue').textContent = value + '%';
    }

    async function saveProximityThreshold() {
      try {
        const threshold = parseFloat(document.getElementById('proximitySlider').value);
        
        const response = await fetch(API_BASE + '/trade-monitoring/proximity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ threshold })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ ${result.message}\n\nThe bot will now trigger AI evaluation when trades are within ${threshold}% of DCA, Stop Loss, or Take Profit levels.`);
        } else {
          alert('‚ùå Failed to update threshold: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error saving proximity threshold:', error);
        alert('‚ùå Error saving settings: ' + error.message);
      }
    }

    // Active Trades Dashboard functions
    async function updateActiveTradesDisplay() {
      try {
        console.log('üìä Fetching active trades...');
        const response = await fetch(API_BASE + '/active-trades');
        console.log('üìä Active trades response status:', response.status);
        const activeTrades = await response.json();
        console.log('üìä Active trades data:', activeTrades);
        const container = document.getElementById('active-trades-container');

        if (!activeTrades || activeTrades.length === 0) {
          container.innerHTML = `
            <div class="no-active-trades">
              <h3>No Active Trades</h3>
              <p>Active trades will appear here when BUY or SELL signals are triggered.</p>
            </div>
          `;
          return;
        }

        // Build table HTML
        let html = '<table class="trades-table">';
        html += '<thead><tr>';
        html += '<th>Coin</th>';
        html += '<th>Action</th>';
        html += '<th>Position</th>';
        html += '<th>Entry</th>';
        html += '<th>Current</th>';
        html += '<th>TP</th>';
        html += '<th>SL</th>';
        html += '<th>DCA</th>';
        html += '<th>P&L</th>';
        html += '<th>Status</th>';
        html += '<th>Opened</th>';
        html += '</tr></thead><tbody>';
        
        activeTrades.forEach(trade => {
          const pnlValue = parseFloat(trade.pnlPercent);
          const pnlClass = pnlValue > 0 ? 'positive' : pnlValue < 0 ? 'negative' : 'neutral';
          const pnlSign = pnlValue > 0 ? '+' : '';
          const actionBadgeClass = trade.action === 'BUY' ? 'buy' : 'sell';
          const statusBadgeClass = trade.status.toLowerCase(); // OPEN -> open, TP_HIT -> tp_hit, etc.
          
          // Calculate position size
          const quantity = trade.quantity || (100 / trade.entryPrice); // $100 position size
          const positionValue = quantity * trade.currentPrice; // Current position value
          
          html += '<tr>';
          html += `<td><span class="trade-coin-name">${trade.name}</span><br><span class="trade-time-small">${trade.symbol}</span></td>`;
          html += `<td><span class="trade-action-badge ${actionBadgeClass}">${trade.action}</span></td>`;
          html += `<td class="trade-price">${quantity.toFixed(6)}<br><span class="trade-time-small">$${positionValue.toFixed(2)}</span></td>`;
          html += `<td class="trade-price">$${Number(trade.entryPrice).toFixed(2)}</td>`;
          html += `<td class="trade-price">$${Number(trade.currentPrice).toFixed(2)}</td>`;
          html += `<td class="trade-price">$${Number(trade.takeProfit).toFixed(2)}</td>`;
          html += `<td class="trade-price">$${Number(trade.stopLoss).toFixed(2)}</td>`;
          html += `<td class="trade-price">$${Number(trade.addPosition).toFixed(2)}</td>`;
          html += `<td><span class="trade-pnl-value ${pnlClass}">${pnlSign}$${Number(trade.pnl).toFixed(2)}<br>${pnlSign}${trade.pnlPercent}%</span></td>`;
          html += `<td><span class="trade-status-badge ${statusBadgeClass}">${trade.status}</span></td>`;
          html += `<td class="trade-time-small">${new Date(trade.entryTime).toLocaleString()}</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error updating active trades display:', error);
        const container = document.getElementById('active-trades-container');
        if (container) {
          container.innerHTML = `
            <div class="no-active-trades">
              <h3>Error Loading Active Trades</h3>
              <p>Could not fetch active trades. Please check server logs.</p>
            </div>
          `;
        }
      }
    }

    // Closed Trades Dashboard functions
    async function updateClosedTradesDisplay() {
      try {
        console.log('üìä Fetching closed trades...');
        const response = await fetch(API_BASE + '/closed-trades');
        console.log('üìä Closed trades response status:', response.status);
        const closedTrades = await response.json();
        console.log('üìä Closed trades data:', closedTrades);
        const container = document.getElementById('closed-trades-container');

        if (!closedTrades || closedTrades.length === 0) {
          container.innerHTML = `
            <div class="no-active-trades">
              <h3>No Closed Trades</h3>
              <p>Closed trades will appear here for performance tracking.</p>
            </div>
          `;
          return;
        }

        // Sort by closed date (newest first)
        const sortedTrades = closedTrades.sort((a, b) => {
          const dateA = new Date(a.closedAt || a.entryTime);
          const dateB = new Date(b.closedAt || b.entryTime);
          return dateB - dateA;
        });

        // Build table HTML
        let html = '<table class="trades-table">';
        html += '<thead><tr>';
        html += '<th>Coin</th>';
        html += '<th>Action</th>';
        html += '<th>Entry</th>';
        html += '<th>Exit</th>';
        html += '<th>P&L</th>';
        html += '<th>P&L %</th>';
        html += '<th>DCA</th>';
        html += '<th>Status</th>';
        html += '<th>AI Confidence</th>';
        html += '<th>Reason</th>';
        html += '<th>Closed</th>';
        html += '</tr></thead><tbody>';
        
        sortedTrades.forEach(trade => {
          const pnlValue = parseFloat(trade.finalPnlPercent || trade.pnlPercent || 0);
          const pnlClass = pnlValue > 0 ? 'positive' : pnlValue < 0 ? 'negative' : 'neutral';
          const pnlSign = pnlValue > 0 ? '+' : '';
          const actionBadgeClass = trade.action === 'BUY' ? 'buy' : 'sell';
          const statusBadgeClass = trade.status?.toLowerCase() || 'closed';
          const isProfit = pnlValue > 0;
          const statusEmoji = isProfit ? '‚úÖ' : '‚ùå';
          
          html += '<tr>';
          html += `<td><span class="trade-coin-name">${trade.name || trade.symbol}</span><br><span class="trade-time-small">${trade.symbol}</span></td>`;
          html += `<td><span class="trade-action-badge ${actionBadgeClass}">${trade.action}</span></td>`;
          html += `<td class="trade-price">$${Number(trade.entryPrice).toFixed(2)}</td>`;
          html += `<td class="trade-price">$${Number(trade.closePrice || trade.executionPrice || trade.currentPrice).toFixed(2)}</td>`;
          html += `<td><span class="trade-pnl-value ${pnlClass}">${pnlSign}$${Number(trade.finalPnl || trade.pnl || 0).toFixed(2)}</span></td>`;
          html += `<td><span class="trade-pnl-value ${pnlClass}">${pnlSign}${pnlValue.toFixed(2)}%</span></td>`;
          html += `<td class="trade-price">${trade.dcaCount || 0}/5</td>`;
          html += `<td><span class="trade-status-badge ${statusBadgeClass}">${statusEmoji} ${trade.status || 'CLOSED'}</span></td>`;
          html += `<td class="trade-price">${trade.aiConfidence ? (trade.aiConfidence * 100).toFixed(0) + '%' : 'N/A'}</td>`;
          html += `<td class="trade-time-small" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${trade.closeReason || 'N/A'}">${trade.closeReason || 'N/A'}</td>`;
          html += `<td class="trade-time-small">${new Date(trade.closedAt || trade.entryTime).toLocaleString()}</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (error) {
        console.error('Error updating closed trades display:', error);
        const container = document.getElementById('closed-trades-container');
        if (container) {
          container.innerHTML = `
            <div class="no-active-trades">
              <h3>Error Loading Closed Trades</h3>
              <p>Could not fetch closed trades. Please check server logs.</p>
            </div>
          `;
        }
      }
    }

    // Portfolio display functions
    async function updatePortfolioDisplay() {
      try {
        console.log('üìä Fetching portfolio...');
        const response = await fetch(API_BASE + '/portfolio');
        console.log('üìä Portfolio response status:', response.status);
        const portfolio = await response.json();
        console.log('üìä Portfolio data:', portfolio);
        
        // Update portfolio metrics
        document.getElementById('portfolio-initial').textContent = `$${Number(portfolio.initialCapital || 10000).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('portfolio-balance').textContent = `$${Number(portfolio.currentBalance || 10000).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('portfolio-equity').textContent = `$${Number(portfolio.totalEquity || portfolio.currentBalance || 10000).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // P&L with color coding
        const totalPnl = portfolio.totalPnl || 0;
        const pnlEl = document.getElementById('portfolio-pnl');
        pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${Number(totalPnl).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        pnlEl.className = 'portfolio-metric-value' + (totalPnl > 0 ? ' positive' : totalPnl < 0 ? ' negative' : '');
        
        // ROI with color coding
        const roi = portfolio.roi || 0;
        const roiEl = document.getElementById('portfolio-roi');
        roiEl.textContent = `${roi >= 0 ? '+' : ''}${Number(roi).toFixed(2)}%`;
        roiEl.className = 'portfolio-metric-value' + (roi > 0 ? ' positive' : roi < 0 ? ' negative' : '');
        
        // Win rate
        document.getElementById('portfolio-winrate').textContent = `${Number(portfolio.winRate || 0).toFixed(2)}%`;
        
        // Total trades
        document.getElementById('portfolio-trades').textContent = portfolio.totalTrades || 0;
        
        // Open positions
        document.getElementById('portfolio-open').textContent = portfolio.openPositions || 0;
        
      } catch (error) {
        console.error('‚ùå Error updating portfolio display:', error);
        console.error('Error stack:', error.stack);
      }
    }

    async function updateAnalyticsDisplay() {
      try {
        console.log('üìä Fetching analytics...');
        const response = await fetch(API_BASE + '/analytics');
        console.log('üìä Analytics response status:', response.status);
        
        if (!response.ok) {
          console.warn('Analytics endpoint returned non-OK status');
          return;
        }
        
        const analytics = await response.json();
        console.log('üìä Analytics data:', analytics);
        
        // Update analytics display
        const container = document.getElementById('analytics-content');
        const loading = document.getElementById('analytics-loading');
        
        if (loading) loading.style.display = 'none';
        if (container) container.style.display = 'block';
        
        // Update individual metrics
        if (analytics.sharpeRatio !== undefined) {
          const el = document.getElementById('analytics-sharpe');
          if (el) el.textContent = analytics.sharpeRatio.toFixed(2);
        }
        if (analytics.maxDrawdown !== undefined) {
          const el = document.getElementById('analytics-drawdown');
          if (el) el.textContent = analytics.maxDrawdown.toFixed(2) + '%';
        }
        
      } catch (error) {
        console.error('‚ùå Error updating analytics display:', error);
        console.error('Error stack:', error.stack);
      }
    }

    // Log window functions
    let logEntries = [];
    let lastLogId = 0;

    function appendLog(message, level = 'info') {
      const logContainer = document.getElementById('log-container');
      const logEntry = document.createElement('div');
      
      const timestamp = new Date().toLocaleTimeString();
      logEntry.className = `log-entry log-${level}`;
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${escapeHtml(message)}</span>
      `;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom
      
      // Keep only last 500 entries to prevent memory issues
      if (logContainer.children.length > 500) {
        logContainer.removeChild(logContainer.firstChild);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Clear logs button
    document.addEventListener('DOMContentLoaded', function() {
      const clearBtn = document.getElementById('clear-logs');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          document.getElementById('log-container').innerHTML = '';
          appendLog('Logs cleared. Waiting for new activity...', 'info');
        });
      }
    });

    // Fetch logs from server
    async function fetchLogs() {
      try {
        const response = await fetch(API_BASE + '/logs?since=' + lastLogId);
        const data = await response.json();
        
        if (data.logs && Array.isArray(data.logs)) {
          // Add new logs
          data.logs.forEach(log => {
            appendLog(log.message, log.level || 'info');
            lastLogId = Math.max(lastLogId, log.id);
          });
        }
      } catch (error) {
        // Silently fail - logs endpoint might not be implemented yet
        // console.log('Logs endpoint not available:', error.message);
      }
    }

    // Initialize
    console.log('‚úÖ Starting dashboard initialization...');
    console.log('üìä API_BASE:', API_BASE);
    
    // Test API connectivity first
    fetch(API_BASE + '/health').then(r => {
      console.log('‚úÖ Health check status:', r.status);
      return r.json();
    }).then(data => {
      console.log('‚úÖ Health data:', data);
    }).catch(err => {
      console.error('‚ùå Health check failed:', err);
    });
    
    updateStats();
    updateAIEvaluation();
    updateActiveTradesDisplay(); // Initial load of active trades
    updateClosedTradesDisplay(); // Initial load of closed trades
    updatePortfolioDisplay(); // Initial load of portfolio
    console.log('‚úÖ Initial data fetch started');

    // AI Trade Re-evaluation function
    async function evaluateTradesWithAI() {
      const btn = document.getElementById('evaluateTradesBtn');
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Evaluating...';
        btn.style.opacity = '0.6';
        
        const response = await fetch(API_BASE + '/evaluate-trades', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          btn.textContent = '‚úÖ Evaluation Sent!';
          btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
          
          // Show success message
          alert(`‚úÖ AI Re-evaluation Complete!\n\n${result.message || 'Evaluation results sent to Telegram'}`);
          
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
          }, 3000);
        } else {
          throw new Error(result.error || 'Evaluation failed');
        }
      } catch (error) {
        console.error('Evaluation error:', error);
        btn.textContent = '‚ùå Error';
        btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        alert(`‚ùå Evaluation Failed: ${error.message}`);
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        }, 3000);
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }
    // Analytics Dashboard Functions
    async function updateAnalyticsDisplay() {
      try {
        const response = await fetch(API_BASE + '/analytics');
        const analytics = await response.json();
        
        if (analytics && analytics.sharpeRatio !== undefined) {
          document.getElementById('analytics-loading').style.display = 'none';
          document.getElementById('analytics-content').style.display = 'block';
          
          // Update metrics
          document.getElementById('analytics-sharpe').textContent = analytics.sharpeRatio.toFixed(2);
          document.getElementById('analytics-drawdown').textContent = `${analytics.maxDrawdownPercent.toFixed(2)}%`;
          document.getElementById('analytics-holding').textContent = `${analytics.holdingTime?.avgDays.toFixed(1) || 0} days`;
          
          if (analytics.bestTrades && analytics.bestTrades.length > 0) {
            const best = analytics.bestTrades[0];
            document.getElementById('analytics-best').textContent = `${best.symbol}: +${best.pnlPercent.toFixed(2)}%`;
          }
          
          // Update win rate by coin
          const winRateContainer = document.getElementById('analytics-winrate-by-coin');
          if (analytics.winRateByCoin && Object.keys(analytics.winRateByCoin).length > 0) {
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">';
            Object.entries(analytics.winRateByCoin)
              .sort((a, b) => b[1].winRate - a[1].winRate)
              .forEach(([symbol, stats]) => {
                html += `<div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid ${stats.winRate > 50 ? '#22c55e' : '#ef4444'};">
                  <div style="font-weight: 600; color: #0f172a;">${symbol}</div>
                  <div style="font-size: 1.2em; font-weight: 700; color: ${stats.winRate > 50 ? '#22c55e' : '#ef4444'};">${stats.winRate.toFixed(1)}%</div>
                  <div style="font-size: 0.8em; color: #64748b;">${stats.wins}W/${stats.losses}L</div>
                </div>`;
              });
            html += '</div>';
            winRateContainer.innerHTML = html;
          } else {
            winRateContainer.innerHTML = '<p style="color: #64748b; text-align: center;">No trade data available</p>';
          }
        }
      } catch (error) {
        console.error('Error updating analytics:', error);
      }
    }

    updatePortfolioDisplay(); // Initial load of portfolio
    updateAnalyticsDisplay(); // Initial load of analytics
    setInterval(updateStats, 30000);
    setInterval(updateAIEvaluation, 5000); // Update AI display every 5 seconds
    setInterval(updateActiveTradesDisplay, 10000); // Update active trades every 10 seconds
    setInterval(updateClosedTradesDisplay, 10000); // Update closed trades every 10 seconds
    setInterval(updatePortfolioDisplay, 10000); // Update portfolio every 10 seconds
    setInterval(updateAnalyticsDisplay, 30000); // Update analytics every 30 seconds
    setInterval(updateNextScanTime, 5000); // Update next scan time every 5 seconds
    
    // Initialize log window
    appendLog('Bot initialized. Waiting for activity...', 'info');
    appendLog('Ready to scan cryptocurrencies', 'success');
    
    // Poll for logs every 2 seconds
    setInterval(fetchLogs, 2000);
    
    // Wrap existing functions to add logging
    const originalManualScanFn = manualScan;
    window.manualScan = async function() {
      appendLog('Manual scan initiated...', 'info');
      try {
        await originalManualScanFn();
        appendLog('Scan completed', 'success');
      } catch (error) {
        appendLog('Scan failed: ' + error.message, 'error');
      }
    };
    
    const originalStartAutoScanFn = startAutoScan;
    window.startAutoScan = async function() {
      appendLog('Auto-scan started', 'success');
      await originalStartAutoScanFn();
    };
    
    const originalStopAutoScanFn = stopAutoScan;
    window.stopAutoScan = async function() {
      appendLog('Auto-scan stopped', 'warning');
      await originalStopAutoScanFn();
    };
    
    // Free AI Monitoring Display Functions
    let monitoringData = [];
    const MAX_MONITORING_ENTRIES = 10;
    
    async function updateMonitoringDisplay() {
      try {
        const response = await fetch(API_BASE + '/monitoring-activity');
        if (!response.ok) {
          console.log('Monitoring API error:', response.status);
          return;
        }
        const data = await response.json();
        
        console.log('üìä Monitoring data received:', {
          activityCount: data?.activity?.length || 0,
          isActive: data?.isActive,
          activities: data?.activity
        });
        
        const container = document.getElementById('monitoring-container');
        if (!container) {
          console.log('‚ö†Ô∏è Monitoring container not found');
          return;
        }
        
        if (!data || !data.activity || data.activity.length === 0) {
          // Show waiting message only if container is empty
          if (!container.innerHTML.includes('Waiting for monitoring cycle')) {
            container.innerHTML = `
              <div style="text-align: center; padding: 20px; color: #94a3b8;">
                <div style="font-size: 2em; margin-bottom: 8px;">‚è≥</div>
                <div>Waiting for monitoring cycle...</div>
                <div style="font-size: 0.8em; margin-top: 8px; color: #64748b;">No activities yet</div>
              </div>
            `;
          }
          return;
        }
        
        const statusBadge = document.getElementById('monitoring-status');
        if (!statusBadge) return;
        
        // Update status
        if (data.isActive) {
          statusBadge.textContent = 'ACTIVE';
          statusBadge.style.background = 'rgba(34, 197, 94, 0.2)';
          statusBadge.style.color = '#22c55e';
        } else {
          statusBadge.textContent = 'IDLE';
          statusBadge.style.background = 'rgba(148, 163, 184, 0.2)';
          statusBadge.style.color = '#94a3b8';
        }
        
        // Keep only last MAX_MONITORING_ENTRIES
        const activities = data.activity.slice(-MAX_MONITORING_ENTRIES).reverse();
        
        let html = '';
        activities.forEach(activity => {
          const volatilityColor = activity.volatility === 'high' ? '#ef4444' : activity.volatility === 'medium' ? '#f59e0b' : '#94a3b8';
          const escalatedBadge = activity.escalated ? '<span style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 4px;">üíé ESCALATED</span>' : '';
          const time = new Date(activity.timestamp).toLocaleTimeString();
          
          html += `
            <div style="padding: 10px; margin-bottom: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; border-left: 3px solid ${volatilityColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span style="font-weight: 700; color: #e2e8f0; font-size: 0.95em;">${activity.symbol || 'N/A'}</span>
                <span style="font-size: 0.7em; color: #64748b;">${time}</span>
              </div>
              <div style="font-size: 0.85em; color: #94a3b8; margin-bottom: 4px;">
                <span style="color: ${volatilityColor}; font-weight: 600;">${(activity.volatility || 'low').toUpperCase()}</span> volatility: ${activity.priceChange || '0.00'}%
              </div>
              ${activity.confidence ? `<div style="font-size: 0.8em; color: #38bdf8;">Confidence: ${(activity.confidence * 100).toFixed(0)}%</div>` : ''}
              ${escalatedBadge}
            </div>
          `;
        });
        
        container.innerHTML = html;
        container.scrollTop = 0; // Scroll to top (newest)
        
      } catch (error) {
        console.log('Error updating monitoring display:', error);
      }
    }
    
    // Poll monitoring activity every 15 seconds (reduced to minimize log noise)
    setInterval(updateMonitoringDisplay, 15000);
    updateMonitoringDisplay(); // Initial load
    // Trigger Settings Modal Functions
    function openTriggerSettings() {
      document.getElementById('trigger-settings-modal').style.display = 'flex';
      loadTriggerSettings();
    }
    
    function closeTriggerSettings() {
      document.getElementById('trigger-settings-modal').style.display = 'none';
    }
    
    let currentMode = 'ai'; // Track current mode
    
    async function loadTriggerSettings() {
      try {
        const response = await fetch(API_BASE + '/trigger-settings');
        const settings = await response.json();
        
        document.getElementById('rsi-oversold').value = settings.rsiOversold || 30;
        document.getElementById('rsi-overbought').value = settings.rsiOverbought || 70;
        document.getElementById('enable-bollinger').checked = settings.enableBollinger !== false;
        document.getElementById('min-price-change').value = settings.minPriceChange || 5;
        document.getElementById('min-triggers').value = settings.minTriggers || 2;
        document.getElementById('require-volume').checked = settings.requireVolume || false;
        
        // Load current mode
        currentMode = settings.monitoringMode || 'ai';
        updateModeButtons(currentMode);
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }
    
    function updateModeButtons(mode) {
      const aiBtn = document.getElementById('mode-ai');
      const algBtn = document.getElementById('mode-algorithmic');
      
      if (mode === 'ai') {
        aiBtn.style.background = 'rgba(99, 102, 241, 0.3)';
        aiBtn.style.borderColor = 'rgba(99, 102, 241, 0.6)';
        aiBtn.style.color = '#a5b4fc';
        algBtn.style.background = 'rgba(34, 197, 94, 0.1)';
        algBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
        algBtn.style.color = '#4ade80';
      } else {
        algBtn.style.background = 'rgba(34, 197, 94, 0.3)';
        algBtn.style.borderColor = 'rgba(34, 197, 94, 0.6)';
        algBtn.style.color = '#86efac';
        aiBtn.style.background = 'rgba(99, 102, 241, 0.1)';
        aiBtn.style.borderColor = 'rgba(99, 102, 241, 0.3)';
        aiBtn.style.color = '#818cf8';
      }
      currentMode = mode;
    }
    
    function setMonitoringMode(mode) {
      updateModeButtons(mode);
    }
    
    async function saveTriggerSettings() {
      const settings = {
        rsiOversold: parseInt(document.getElementById('rsi-oversold').value),
        rsiOverbought: parseInt(document.getElementById('rsi-overbought').value),
        enableBollinger: document.getElementById('enable-bollinger').checked,
        minPriceChange: parseFloat(document.getElementById('min-price-change').value),
        minTriggers: parseInt(document.getElementById('min-triggers').value),
        requireVolume: document.getElementById('require-volume').checked,
        monitoringMode: currentMode
      };
      
      try {
        const response = await fetch(API_BASE + '/trigger-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          alert('‚úÖ Settings saved!');
          closeTriggerSettings();
        } else {
          alert('‚ùå Failed to save settings');
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }
    
    // Update trigger display
    async function updateTriggerDisplay() {
      try {
        const response = await fetch(API_BASE + '/active-triggers');
        const data = await response.json();
        
        if (!data.triggers || data.triggers.length === 0) {
          document.getElementById('trigger-summary').innerHTML = '<span style="background: rgba(148, 163, 184, 0.2); padding: 4px 8px; border-radius: 4px;">0 Active</span>';
          document.getElementById('trigger-list').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #94a3b8;">
              <div style="font-size: 1.5em; margin-bottom: 8px;">üéØ</div>
              <div>No active triggers</div>
            </div>
          `;
          return;
        }
        
        const activeCount = data.triggers.reduce((sum, t) => sum + (t.activeTriggers?.length || 0), 0);
        const escalatedCount = data.triggers.filter(t => t.shouldEscalate).length;
        
        document.getElementById('trigger-summary').innerHTML = `
          <span style="background: rgba(251, 191, 36, 0.2); padding: 4px 8px; border-radius: 4px; color: #fbbf24;">${activeCount} Active</span>
          ${escalatedCount > 0 ? `<span style="background: rgba(239, 68, 68, 0.2); padding: 4px 8px; border-radius: 4px; color: #f87171; margin-left: 6px;">${escalatedCount} Escalated</span>` : ''}
        `;
        
        document.getElementById('trigger-list').innerHTML = data.triggers.map(coin => {
          const triggers = coin.activeTriggers || [];
          const bgColor = coin.shouldEscalate ? 'rgba(239, 68, 68, 0.15)' : 'rgba(15, 23, 42, 0.3)';
          const borderColor = coin.shouldEscalate ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.2)';
          
          const getTriggerBadge = (trigger) => {
            const badges = {
              rsiOversold: 'üìâ RSI Low',
              rsiOverbought: 'üìà RSI High',
              bollingerLower: '‚¨áÔ∏è BB Lower',
              bollingerUpper: '‚¨ÜÔ∏è BB Upper',
              highVolatility: 'üå™Ô∏è High Vol',
              bigPriceMove: 'üöÄ Big Move'
            };
            const colors = {
              rsiOversold: '#22c55e',
              rsiOverbought: '#ef4444',
              bollingerLower: '#22c55e',
              bollingerUpper: '#ef4444',
              highVolatility: '#f59e0b',
              bigPriceMove: '#f59e0b'
            };
            return `<span style="background: rgba(148, 163, 184, 0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px; color: ${colors[trigger] || '#94a3b8'}; display: inline-block; margin: 2px;">${badges[trigger] || trigger}</span>`;
          };
          
          return `
            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <span style="font-weight: 700; color: #e2e8f0;">${coin.symbol}</span>
                <span style="font-size: 10px; color: #94a3b8;">${triggers.length} triggers</span>
              </div>
              ${triggers.length > 0 ? `
                <div style="margin-bottom: 6px;">
                  ${triggers.map(t => getTriggerBadge(t)).join(' ')}
                </div>
              ` : ''}
              <div style="font-size: 10px; color: #94a3b8;">
                ${coin.indicators?.rsi ? `RSI: ${coin.indicators.rsi.toFixed(1)}` : ''} 
                ${coin.indicators?.bollingerPosition ? `¬∑ BB: ${coin.indicators.bollingerPosition}` : ''}
              </div>
              ${coin.shouldEscalate ? `<div style="margin-top: 6px; padding: 4px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; font-size: 10px; color: #f87171; font-weight: 600;">‚ö° Escalated to Premium AI</div>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error updating triggers:', error);
      }
    }
    
    // Poll triggers every 30 seconds (reduced to minimize log noise)
    setInterval(updateTriggerDisplay, 30000);
    updateTriggerDisplay();
  </script>
  
  <!-- Trigger Settings Modal -->
  <div id="trigger-settings-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: #1e293b; padding: 32px; border-radius: 16px; max-width: 650px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid rgba(59,130,246,0.3); margin: 20px auto; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; color: #22d3ee; font-size: 1.5em;">‚öôÔ∏è Monitoring Settings</h2>
        <button onclick="closeTriggerSettings()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
      </div>
      
      <!-- Mode Toggle -->
      <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(34, 211, 238, 0.1)); border-radius: 8px; border: 1px solid rgba(59,130,246,0.3);">
        <h3 style="margin: 0 0 12px 0; color: #22d3ee; font-size: 1.1em;">üîÑ Monitoring Mode</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
          <button id="mode-ai" onclick="setMonitoringMode('ai')" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid rgba(99, 102, 241, 0.3); background: rgba(99, 102, 241, 0.2); color: #818cf8; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            ü§ñ AI Mode
          </button>
          <button id="mode-algorithmic" onclick="setMonitoringMode('algorithmic')" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.3); background: rgba(34, 197, 94, 0.1); color: #4ade80; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            üéØ Algorithmic Mode
          </button>
        </div>
        <div id="mode-description" style="font-size: 13px; color: #94a3b8; line-height: 1.5;">
          <strong>AI Mode:</strong> Uses DeepSeek AI for monitoring (~$0.001/hour)<br>
          <strong>Algorithmic Mode:</strong> Uses technical indicators ($0, instant)
        </div>
      </div>
      
      <div style="margin-bottom: 20px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
        <h3 style="margin: 0 0 12px 0; color: #22d3ee; font-size: 1em;">üìä RSI Thresholds</h3>
        <label style="display: block; margin-bottom: 8px; color: #e2e8f0; font-size: 14px;">
          Oversold (Buy Signal): 
          <input type="number" id="rsi-oversold" value="30" min="0" max="100" style="margin-left: 10px; padding: 6px; border-radius: 4px; border: 1px solid rgba(59,130,246,0.3); background: rgba(0,0,0,0.3); color: #e2e8f0; width: 80px;">
        </label>
        <label style="display: block; color: #e2e8f0; font-size: 14px;">
          Overbought (Sell Signal): 
          <input type="number" id="rsi-overbought" value="70" min="0" max="100" style="margin-left: 10px; padding: 6px; border-radius: 4px; border: 1px solid rgba(59,130,246,0.3); background: rgba(0,0,0,0.3); color: #e2e8f0; width: 80px;">
        </label>
      </div>
      
      <div style="margin-bottom: 20px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
        <h3 style="margin: 0 0 12px 0; color: #22d3ee; font-size: 1em;">üìà Bollinger Bands</h3>
        <label style="display: flex; align-items: center; margin-bottom: 8px; color: #e2e8f0; font-size: 14px;">
          <input type="checkbox" id="enable-bollinger" checked style="margin-right: 8px;">
          Enable Bollinger Band triggers
        </label>
        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
          Triggers on upper/lower band breakouts
        </div>
      </div>
      
      <div style="margin-bottom: 20px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
        <h3 style="margin: 0 0 12px 0; color: #22d3ee; font-size: 1em;">üí∏ Price Movement</h3>
        <label style="display: block; color: #e2e8f0; font-size: 14px;">
          Min Price Change (%): 
          <input type="number" id="min-price-change" value="5" min="1" max="20" step="0.5" style="margin-left: 10px; padding: 6px; border-radius: 4px; border: 1px solid rgba(59,130,246,0.3); background: rgba(0,0,0,0.3); color: #e2e8f0; width: 80px;">
        </label>
      </div>
      
      <div style="margin-bottom: 24px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
        <h3 style="margin: 0 0 12px 0; color: #22d3ee; font-size: 1em;">Escalation Rules</h3>
        <label style="display: block; margin-bottom: 8px; color: #e2e8f0; font-size: 14px;">
          Min Triggers Required: 
          <input type="number" id="min-triggers" value="2" min="1" max="5" style="margin-left: 10px; padding: 6px; border-radius: 4px; border: 1px solid rgba(59,130,246,0.3); background: rgba(0,0,0,0.3); color: #e2e8f0; width: 80px;">
        </label>
        <label style="display: flex; align-items: center; color: #e2e8f0; font-size: 14px;">
          <input type="checkbox" id="require-volume" style="margin-right: 8px;">
          Require volume spike
        </label>
      </div>
      
      <button onclick="saveTriggerSettings()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1, #22d3ee); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üíæ Save Settings</button>
    </div>
  </div>
</body>
</html>
